"use strict";function showPlot(a){function b(){return d3.svg.axis().scale(m).orient("bottom").tickPadding(2)}function c(){return d3.svg.axis().scale(n).orient("left").tickPadding(2)}function d(a,b,c,d){var f=d3.min(r),g=e(d3.min(r)),h=d3.max(r),i=e(d3.max(r)),j=[[f,g,h,i]],k=l.selectAll("."+b).data(j);k.enter().append("line").attr("class",b).attr("x1",function(a){return m(a[0])}).attr("y1",function(a){return n(a[1])}).attr("x2",function(a){return m(a[2])}).attr("y2",function(a){return n(a[3])}).attr("stroke-dasharray","10,10").attr("stroke",c).attr("stroke-width",d).attr("opacity",0).transition().attr("opacity",1).delay(0).duration(1e3)}function e(a){return t[0]*a+t[1]}function f(a){var b=a.map(function(a){var b=a[1].Close-e(a[0].Close),c=b*b;return c}),c=g(b),d=Math.sqrt(c);return d}function g(a){var b=a.reduce(function(a,b){return a+b},0),c=b/a.length;return c}y&&y.transition().attr("opacity",0).duration(500),$("#plot").empty(),console.log(a[0][0].Close),console.log(a[1][0].Close);var h={left:70,right:30,top:30,bottom:50},i=$(document).width(),j=$(document).height()-100,k=d3.scale.linear().domain([0,a.length]).interpolate(d3.interpolateHsl).range(["#ff0000","#0000ff"]),l=d3.select("#plot").append("svg").attr("width",i).attr("height",j).append("g").attr("transform","translate("+h.left+","+h.top+")"),m=d3.scale.linear().domain(d3.extent(a,function(a){return parseFloat(a[0].Close)})).range([0,i-h.left-h.right]),n=d3.scale.linear().domain(d3.extent(a,function(a){return parseFloat(a[1].Close)})).range([j-h.top-h.bottom,0]),o=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);l.append("text").attr("fill","#555").attr("class","label").attr("text-anchor","end").attr("x",i/2).attr("y",j-35).text(a[0][0].Symbol),l.append("text").attr("fill","#555").attr("class","label").attr("transform","rotate(-90)").attr("y",-50).attr("x",-(j/2)).attr("dy",".71em").text(a[0][1].Symbol),l.append("g").attr("class","x axis").attr("transform","translate(0,"+n.range()[0]+")"),l.append("g").attr("class","y axis");var p=d3.svg.axis().scale(m).orient("bottom").tickPadding(2),q=d3.svg.axis().scale(n).orient("left").tickPadding(2);l.append("g").attr("class","grid").attr("transform","translate(0,"+j+")").call(b().tickSize(-j,0,0).tickFormat("")),l.append("g").attr("class","grid").call(c().tickSize(-i,0,0).tickFormat(""));var r=a.map(function(a){return parseFloat(a[0].Close)}),s=a.map(function(a){return parseFloat(a[1].Close)}),t=leastSquares(r,s);l.append("text").attr("class","label").attr("x",i/2+100).attr("y",j-35).text("r squared: "+t[2].toString()),l.append("text").attr("class","label").attr("x",i/2+100).attr("y",j-45).text("slope: "+t[0].toString());d3.svg.line().x(function(a){return parseFloat(m(a[0].Close))}).y(function(a){return parseFloat(n(a[1].Close))}).interpolate("cardinal"),l.selectAll(".pathline").data(a);$("#plot").animate({opacity:1}),d(t,"trendline","#888",2);var u=f(a),v=t;v[1]+=u,d(v,"sdline","#555",1);var w=t;w[1]-=2*u,d(w,"sdline2","#555",1);l.selectAll("g.y.axis").call(q),l.selectAll("g.x.axis").call(p);var x=l.selectAll("g.node").data(a,function(a){return a[2]}),y=x.enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+m(a[0].Close)+","+n(a[1].Close)+")"}),z=parseInt($("input#months_ago").val());y.append("circle").attr("r",0).attr("class","dot").style("fill",function(b){return k(a.indexOf(b))}).on("mouseover",function(a){o.transition().duration(200).style("opacity",.9),o.html("<b>"+moment(a[2],"YYYY-MM-DD").format("LL")+"</b><br/>"+a[0].Symbol+": "+a[0].Close+"<br />"+a[1].Symbol+": "+a[1].Close).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(){o.transition().duration(500).style("opacity",0)}).transition().attr("r",function(b){if(0==a.indexOf(b)){var c=this;return setInterval(function(){d3.select(c).attr("r",12).transition().duration(300).attr("r",10)},1e3),10}return 5}).duration(200).delay(function(b){return(a.length-a.indexOf(b))*(5/z)*3})}function leastSquares(a,b){var c=function(a,b){return a+b},d=1*a.reduce(c)/a.length,e=1*b.reduce(c)/b.length,f=a.map(function(a){return Math.pow(a-d,2)}).reduce(c),g=b.map(function(a){return Math.pow(a-e,2)}).reduce(c),h=a.map(function(a,c){return(a-d)*(b[c]-e)}).reduce(c),i=h/f,j=e-d*i,k=Math.pow(h,2)/(f*g);return[i,j,k]}function handleSubmit(){$("#plot").animate({opacity:0},300);var a=$("input#months_ago").val(),b=require("moment"),c=b().format("YYYY-MM-DD"),d=b().subtract(parseInt(a),"months").format("YYYY-MM-DD");return getStocksSortedByDay({stocks:[$("#s1").val(),$("#s2").val()],startDate:d,endDate:c},"historicaldata",function(a,b){showPlot(b)}),!1}var App=require("./app.js");require("./yahoo-finance-stock-data.js");var d3=require("d3-browserify"),stocks=["MSFT","AAPL"],monthsAgo=$("input#months_ago").val(),moment=require("moment"),d2=moment().format("YYYY-MM-DD"),d1=moment().subtract(parseInt(monthsAgo),"months").format("YYYY-MM-DD");getStocksSortedByDay({stocks:[$("#s1").val(),$("#s2").val()],startDate:d1,endDate:d2},"historicaldata",function(a,b){showPlot(b)});var form=$("#req_form").submit(function(a){a.preventDefault(),handleSubmit()});